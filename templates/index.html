<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phishing Awareness Detector</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .risk-high { color: #dc3545; font-weight: bold; }
    .risk-medium { color: #fd7e14; font-weight: bold; }
    .risk-low { color: #198754; font-weight: bold; }
    .feature-card { transition: transform 0.2s; }
    .feature-card:hover { transform: translateY(-5px); }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/">Phishing Shield</a>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Phishing URL Detector</h3>
          </div>
          <div class="card-body">
            <form id="urlForm" novalidate>
              <div class="mb-3">
                <label for="urlInput" class="form-label">Enter URL to Check:</label>
                <input type="url" class="form-control" id="urlInput" placeholder="https://example.com" required />
                <div class="invalid-feedback">Please enter a valid URL (e.g., https://example.com)</div>
              </div>
              <button type="submit" id="submitBtn" class="btn btn-primary">
                Check URL
              </button>
              <span id="loading" class="ms-2" style="display:none;">Checking…</span>
            </form>

            <div id="result" class="mt-4" style="display: none;">
              <div class="alert" id="resultAlert">
                <h5 id="resultTitle" class="mb-1"></h5>
                <p id="resultDetails" class="mb-2"></p>
                <div id="featureAnalysis"></div>
              </div>
            </div>

          </div>
        </div>

        <!-- Optional: Tips card -->
        <div class="card mt-3 feature-card">
          <div class="card-body">
            <strong>Tip:</strong>
            Kabhi bhi unknown sender ke links mat kholiyega; domain ko dhyan se verify karein (misspellings, extra hyphens, punycode).
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('urlForm');
    const input = document.getElementById('urlInput');
    const btn = document.getElementById('submitBtn');
    const loadingEl = document.getElementById('loading');

    const resultDiv = document.getElementById('result');
    const resultAlert = document.getElementById('resultAlert');
    const resultTitle = document.getElementById('resultTitle');
    const resultDetails = document.getElementById('resultDetails');
    const featureAnalysis = document.getElementById('featureAnalysis');

    function toTitleCase(str) {
      return str
        .replace(/_/g, ' ')
        .split(' ')
        .map(s => s ? s[0].toUpperCase() + s.slice(1).toLowerCase() : s)
        .join(' ');
    }

    function riskClass(level) {
      const l = (level || '').toLowerCase();
      if (l === 'high') return 'risk-high';
      if (l === 'medium') return 'risk-medium';
      return 'risk-low';
    }

    function setLoading(isLoading) {
      btn.disabled = isLoading;
      loadingEl.style.display = isLoading ? 'inline' : 'none';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Basic front-end validation & normalization
      const raw = (input.value || '').trim();
      if (!raw) {
        input.classList.add('is-invalid');
        return;
      }
      input.classList.remove('is-invalid');

      // Ensure scheme present (helps backend)
      const url = /^https?:\/\//i.test(raw) ? raw : `https://${raw}`;

      setLoading(true);
      resultDiv.style.display = 'none';
      featureAnalysis.innerHTML = '';
      resultTitle.textContent = '';
      resultDetails.textContent = '';

      try {
        const response = await fetch('/check-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        // Handle non-2xx cleanly
        if (!response.ok) {
          const text = await response.text().catch(()=>'');
          throw new Error(`Server error ${response.status}: ${text || 'No details'}`);
        }

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Unknown error from server');
        }

        const result = data.result || {};
        const features = data.features || {};

        // Alert styling based on risk
        if (result.is_phishing) {
          resultAlert.className = 'alert alert-danger';
          resultTitle.textContent = '⚠ Phishing Detected!';
          resultTitle.className = 'risk-high';
        } else {
          resultAlert.className = 'alert alert-success';
          resultTitle.textContent = '✅ Safe URL';
          resultTitle.className = 'risk-low';
        }

        // Build details safely
        const confidence = typeof result.confidence === 'number' ? (result.confidence * 100).toFixed(2) + '%' : 'N/A';
        const riskLevel = (result.risk_level || 'Low');
        const riskSpan = document.createElement('span');
        riskSpan.className = riskClass(riskLevel);
        riskSpan.textContent = riskLevel;

        // Clear and append lines
        resultDetails.innerHTML = '';
        const line1 = document.createElement('div');
        line1.textContent = `Confidence: ${confidence}`;
        const line2 = document.createElement('div');
        line2.append('Risk Level: ', riskSpan);
        resultDetails.append(line1, line2);

        // Feature analysis (safe DOM APIs)
        featureAnalysis.innerHTML = '<h6>Feature Analysis:</h6>';
        const list = document.createElement('div');

        Object.entries(features).forEach(([feature, value]) => {
          const row = document.createElement('div');
          row.className = 'mb-1';
          const small = document.createElement('small');
          small.textContent = `${toTitleCase(feature)}: ${String(value)}`;
          row.appendChild(small);
          list.appendChild(row);
        });

        featureAnalysis.appendChild(list);
        resultDiv.style.display = 'block';

      } catch (err) {
        alert('Error checking URL: ' + (err?.message || err));
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>